<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR-скриншот</title>

  <!-- ваши старые стили -->
  <link rel="stylesheet" href="spinner.css">
  <link rel="stylesheet" href="scanning.css">

  <!-- новые стили поп-апов -->
  <link rel="stylesheet" href="capture.css">

  <!-- библиотеки MindAR + A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
  <script src="marker-tracker.js"></script>
</head>

<body>
  <!-- оверлей сканирования -->
  <div id="scanning-overlay" class="hidden">
    <div class="scanning-container">
      <div class="image-carousel">
        <img class="main-image active" src="Images/gena_cheba_shapo.png" alt="Gena Cheba Shapo">
        <img class="main-image" src="Images/cheba.png" alt="Cheba">
        <img class="main-image" src="Images/gena.png" alt="Gena">
        <img class="main-image" src="Images/shapo.png" alt="Shapo">
        <img class="main-image" src="Images/volk.png" alt="Volk">
      </div>
      <img class="camera-icon" src="Images/camera_icon.png" alt="Camera">
      <div class="scanning-text">Наведите камеру<br>на одну или несколько скульптур</div>
    </div>
  </div>

  <!-- Access Popup -->
  <div class="access-popup">
    <img src="Images/access_popup.png" alt="Access Permission">
  </div>

  <!-- оверлей загрузки -->
  <div id="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Загружаем ваше будущее «Вааау». Пожалуйста, подождите</div>
    </div>
  </div>

  <!-- блок пульта с кнопкой -->
  <div id="pultContainer">
    <img src="Images/Pult.gif" alt="Pult" id="pultImage">
    <button id="photoBtn" disabled></button>
  </div>

  <!-- поп-ап превью -->
  <div id="previewOverlay" class="hidden">
    <div id="previewBox">
      <button id="closeBtn" class="close-button">
        <img src="Images/close_button.png" alt="Close">
      </button>
      <div class="camera-illustration">
        <img src="Images/camera_illustration.png" alt="Camera">
      </div>
      <img id="previewImg" alt="preview">
      <div class="save-text">Нажмите СОХРАНИТЬ<br>и подтвердите загрузку<br>вашей фотографии</div>
      <button id="downloadBtn" class="download-button">
        <img src="Images/button_save.png" alt="Save">
      </button>
    </div>
  </div>

  <!-- поп-ап после скачивания -->
  <div id="afterOverlay" class="hidden">
    <div id="afterBox">
      <img id="afterImg" src="https://via.placeholder.com/400x300/007aff/ffffff?text=Супер!" alt="заставка">
      <p> </p>
      <a href="https://souzmultpark.ru/" target="_blank">
        <button id="goParkBtn">Посмотреть сеансы</button>
      </a>
      <button id="laterBtn">В другой раз обязательно!</button>
    </div>
  </div>

  <!-- AR-сцена (ваша) -->
  <a-scene
  mindar-image="
    imageTargetSrc: sm_3x.mind;
    maxTrack: 3;
    uiLoading: #loading-overlay;
    uiScanning: #scanning-overlay;
    uiError: no;
    deviceConstraints: {
      video: {
        width:  { ideal: 1280 },
        height: { ideal: 720  },
        facingMode: 'environment'
      }
    }"
  color-space="sRGB"
  renderer="colorManagement: true, physicallyCorrectLights"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

    <!-- Ассеты -->
    <a-assets>
      <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"/>
      <a-asset-item id="1" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
      <a-asset-item id="2" src="cube.glb"></a-asset-item>
      <img id="Oranges" src="Images/Oranges.png"/>
      <img id="Table" src="Images/Table.png"/>
      <img id="Lariska" src="Images/Lariska.png"/>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane material="shader:flat;" src="#Lariska" position="0.4 -0.5 0" height="1" width="1" rotation="0 0 0"></a-plane>
    </a-entity>

    <!-- Чебурашка -->
    <a-entity mindar-image-target="targetIndex: 1">
      <a-entity id="gif-element" geometry="primitive: plane; height:1; width:2"
                material="shader: gif; src: url(Video.gif)" position="0 2 0" visible="true"></a-entity>
      <a-plane material="shader:flat;" src="#Oranges" position="0 -0.25 0" height="1" width="1" rotation="0 0 0"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2">
      <a-plane material="shader:flat;" src="#Table" position="-0.3 -0.35 0" height="2" width="2" rotation="0 0 0"></a-plane>
    </a-entity>
  </a-scene>

  <!-- логика скриншотов -->
  <script src="capture.js"></script>
  
  <!-- Анимация access popup -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const accessPopup = document.querySelector('.access-popup');
      const loadingOverlay = document.querySelector('#loading-overlay');
      const scanningOverlay = document.querySelector('#scanning-overlay');
      
      // Показываем popup через 1 секунду после загрузки
      setTimeout(() => {
        accessPopup.classList.add('show');
      }, 1000);
      
      // Функция для скрытия popup
      function hidePopup() {
        accessPopup.style.display = 'none';
      }
      
      // Функция для показа popup
      function showPopup() {
        accessPopup.style.display = 'block';
      }
      
      // Скрываем popup при появлении экрана сканирования
      const scanningObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (!scanningOverlay.classList.contains('hidden')) {
              hidePopup();
            }
          }
        });
      });
      
      // Скрываем popup при скрытии экрана загрузки (когда переходим к основному экрану)
      const loadingObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (loadingOverlay.classList.contains('hidden')) {
              hidePopup();
            }
          }
        });
      });
      
      scanningObserver.observe(scanningOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      loadingObserver.observe(loadingOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // Карусель картинок на экране сканирования
      let imageInterval = null;
      
      function startCarousel() {
        const images = document.querySelectorAll('.main-image');
        if (images.length === 0) return;
        
        let currentIndex = 0;
        
        function switchImage() {
          console.log('Switching image, current index:', currentIndex);
          // Убираем активный класс с текущей картинки
          images[currentIndex].classList.remove('active');
          
          // Переходим к следующей картинке
          currentIndex = (currentIndex + 1) % images.length;
          
          // Добавляем активный класс к новой картинке
          images[currentIndex].classList.add('active');
          console.log('New active image index:', currentIndex);
        }
        
        // Очищаем предыдущий интервал если есть
        if (imageInterval) {
          clearInterval(imageInterval);
        }
        
        // Запускаем смену картинок каждые 3 секунды
        imageInterval = setInterval(switchImage, 3000);
        console.log('Carousel started');
      }
      
      // Запускаем карусель сразу
      setTimeout(startCarousel, 100);
      
      // Останавливаем карусель когда экран сканирования скрывается
      const stopCarouselObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (scanningOverlay.classList.contains('hidden')) {
              if (imageInterval) {
                clearInterval(imageInterval);
                imageInterval = null;
                console.log('Carousel stopped');
              }
            } else {
              // Запускаем карусель когда экран сканирования появляется
              setTimeout(startCarousel, 100);
            }
          }
        });
      });
      
      stopCarouselObserver.observe(scanningOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
    });
  </script>
</body>
</html>