<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MindAR ‚Äì Photo</title>

    <!-- –≤–∞—à–∏ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="spinner.css">
    <link rel="stylesheet" href="scanning.css">

    <!-- –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <script src="marker-tracker.js"></script>

    <style>
      #photoBtn{
        position:fixed; bottom:20px; right:20px; z-index:9999;
        padding:12px 24px; background:#fff; border:none; border-radius:8px;
        font-size:16px; box-shadow:0 2px 8px rgba(0,0,0,.25);
      }
       /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø–æ–¥ –ø–æ–ø-–∞–ø */
  #previewOverlay{
    position:fixed; inset:0; z-index:10000;
    background:rgba(0,0,0,.75);
    display:flex; align-items:center; justify-content:center;
  }
  /* –±–µ–ª–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */
  #previewBox{
    background:#fff; border-radius:12px;
    padding:20px; max-width:90vw; max-height:90vh;
    text-align:center; box-shadow:0 8px 32px rgba(0,0,0,.3);
  }
  #previewImg{
    max-width:100%; max-height:70vh; display:block; margin:0 auto 15px;
  }
  #previewBox button{
    margin:6px; padding:10px 20px; font-size:16px; border:none;
    border-radius:6px; cursor:pointer;
  }
  #downloadBtn{ background:#007aff; color:#fff; }
  #closeBtn   { background:#ccc; }

  /* –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ ‚Äì —Ç–∞–∫–∏–µ –∂–µ —Ä–∞–∑–º–µ—Ä—ã –∏ —Å—Ç–∏–ª—å, –∫–∞–∫ –ø—Ä–µ–≤—å—é */
  #afterOverlay{
    position:fixed; inset:0; z-index:10001;
    background:rgba(0,0,0,.75);
    display:flex; align-items:center; justify-content:center;
  }
  #afterBox{
    background:#fff; border-radius:12px;
    padding:20px; max-width:90vw; max-height:90vh;
    text-align:center; box-shadow:0 8px 32px rgba(0,0,0,.3);
  }
  #afterBox img{
    max-width:100%; max-height:50vh; display:block; margin:0 auto 15px;
  }
  #afterBox p{
    margin:0 0 20px; font-size:18px;
  }
  #afterBox a button,
  #afterBox button{
    margin:6px; padding:10px 20px; font-size:16px; border:none;
    border-radius:6px; cursor:pointer;
  }
  #goParkBtn{ background:#007aff; color:#fff; }
  #laterBtn { background:#ccc; }

  .hidden{ display:none !important; }
    </style>

  </head>


  <body>
    <!-- –æ–≤–µ—Ä–ª–µ–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="scanning-overlay" class="hidden">
      <div class="scanning-content">
        <div class="scanning-spinner"></div>
        <div class="scanning-text">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
      </div>
    </div>

    <!-- –æ–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loading-overlay">
      <div class="spinner"></div>
    </div>

    <!-- —Å—Ü–µ–Ω–∞ MindAR -->
    <a-scene mindar-image="imageTargetSrc:sm_3x.mind; maxTrack:3;
                          uiLoading:#loading-overlay; uiScanning:#scanning-overlay; uiError:no;"
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

      <!-- –∞—Å—Å–µ—Ç—ã -->
      <a-assets>
        <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"/>
        <a-asset-item id="1" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
        <a-asset-item id="2" src="cube.glb"></a-asset-item>
      </a-assets>

      <!-- –∫–∞–º–µ—Ä–∞ -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- –º–∞—Ä–∫–µ—Ä 0 -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
        <a-gltf-model rotation="0 0 0" position="0 0 0.1" scale="0.005 0.005 0.005" src="#2"
                      animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"></a-gltf-model>
      </a-entity>

      <!-- –º–∞—Ä–∫–µ—Ä 1 -->
      <a-entity mindar-image-target="targetIndex: 1">
        <a-entity id="gif-element" geometry="primitive: plane; height:1; width:2"
                  material="shader: gif; src: url(Video.gif)" position="0 2 0" visible="true"></a-entity>
        <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
        <a-gltf-model rotation="0 0 0" position="0 0 0.1" scale="0.005 0.005 0.005" src="#1"
                      animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"></a-gltf-model>
      </a-entity>

      <!-- –º–∞—Ä–∫–µ—Ä 2 -->
      <a-entity mindar-image-target="targetIndex: 2">
        <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
        <a-gltf-model rotation="0 0 0" position="0 0 0.1" scale="0.005 0.005 0.005" src="#2"
                      animation="property: position; to: 0 0.1 0.1; dur: 1000; easing: easeInOutQuad; loop: true; dir: alternate"></a-gltf-model>
      </a-entity>
    </a-scene>

    <!-- –∫–Ω–æ–ø–∫–∞ -->
<button id="photoBtn" disabled>üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
<!-- –ø–æ–ø-–∞–ø –ø—Ä–µ–≤—å—é -->
<div id="previewOverlay" class="hidden">
  <div id="previewBox">
    <img id="previewImg" alt="preview">
    <div>
      <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å</button>
      <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>
<!-- –≤—Ç–æ—Ä–æ–π –ø–æ–ø-–∞–ø ¬´–ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è¬ª -->
<div id="afterOverlay" class="hidden">
  <div id="afterBox">
    <!-- —Ç–∞ –∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞, —á—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–∫–∞—á–∞–ª–∏ -->
    <img id="afterImg" alt="screenshot">
    <p>–ö—Ä—É—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å!<br>–ê —Ç–µ–ø–µ—Ä—å –∑–∞—Ö–æ–¥–∏—Ç–µ –∫ –Ω–∞–º –≤ –ø–∞—Ä–∫!</p>
    <a href="https://souzmultpark.ru/" target="_blank">
      <button id="goParkBtn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ–∞–Ω—Å—ã</button>
    </a>
    <button id="laterBtn">–í –¥—Ä—É–≥–æ–π —Ä–∞–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!</button>
  </div>
</div>


    <!-- —Å–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
    <script>
    /* –∂–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è screenshot-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (MindAR 1.2.5) */
const awaitScreenshot = setInterval(() => {
  const scene = document.querySelector('a-scene');
  if (scene && scene.components && scene.components.screenshot) {
    clearInterval(awaitScreenshot);
    document.getElementById('photoBtn').disabled = false;
  }
}, 200);

/* —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–µ–≤—å—é */
const overlay   = document.getElementById('previewOverlay');
const preview   = document.getElementById('previewImg');
const closeBtn  = document.getElementById('closeBtn');
const downBtn   = document.getElementById('downloadBtn');

/* —ç–ª–µ–º–µ–Ω—Ç—ã –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ø-–∞–ø–∞ */
const afterOverlay = document.getElementById('afterOverlay');
const afterImg     = document.getElementById('afterImg');
const laterBtn     = document.getElementById('laterBtn');

function hidePreview(){
  overlay.classList.add('hidden');
  URL.revokeObjectURL(preview.src);
}

closeBtn.addEventListener('click', hidePreview);
overlay.addEventListener('click', e => { if (e.target === overlay) hidePreview(); });

laterBtn.addEventListener('click', () => {
  afterOverlay.classList.add('hidden');
  hidePreview();                 // –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏ –ø—Ä–µ–≤—å—é —Ç–æ–∂–µ
});

afterOverlay.addEventListener('click', e => {
  if (e.target === afterOverlay) afterOverlay.classList.add('hidden');
});

/* –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–∫ –ø–æ ¬´–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ¬ª */
document.getElementById('photoBtn').addEventListener('click', () => {
  const video   = document.querySelector('video');
  const sceneEl = document.querySelector('a-scene');
  if (!video || !video.videoWidth) { alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞'); return; }

  video.pause();

  /* 1. —Å–æ–∑–¥–∞—ë–º –∫–∞–¥—Ä */
  const canvas = document.createElement('canvas');
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const ar = sceneEl.components.screenshot.getCanvas('perspective');
  ctx.drawImage(ar, 0, 0, canvas.width, canvas.height);

  /* 2. –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é */
  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    preview.src = url;
    overlay.classList.remove('hidden');
    video.play();

    /* 3. –∫–Ω–æ–ø–∫–∞ ¬´–°–∫–∞—á–∞—Ç—å¬ª + –≤—Ç–æ—Ä–æ–π –ø–æ–ø-–∞–ø */
    downBtn.onclick = () => {
      const link = document.createElement('a');
      link.href = url;
      link.download = 'mindar_' + Date.now() + '.png';
      link.click();

      /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ —Å —Ç–æ–π –∂–µ –∫–∞—Ä—Ç–∏–Ω–∫–æ–π */
      afterImg.src = url;
      afterOverlay.classList.remove('hidden');
    };
  }, 'image/png');
});
      </script>
  </body>
</html>