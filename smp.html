<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR-—Å–∫—Ä–∏–Ω—à–æ—Ç</title>

  <!-- –≤–∞—à–∏ —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="spinner.css">
  <link rel="stylesheet" href="scanning.css">

  <!-- –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø–æ–ø-–∞–ø–æ–≤ -->
  <link rel="stylesheet" href="capture.css">

  <!-- –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ MindAR + A-Frame -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
  <script src="marker-tracker.js"></script>
</head>

<body>
  <!-- –æ–≤–µ—Ä–ª–µ–π —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="scanning-overlay" class="hidden">
    <div class="scanning-container">
      <div class="image-carousel">
        <img class="main-image active" src="Images/gena_cheba_shapo.png" alt="Gena Cheba Shapo">
        <img class="main-image" src="Images/cheba.png" alt="Cheba">
        <img class="main-image" src="Images/gena.png" alt="Gena">
        <img class="main-image" src="Images/shapo.png" alt="Shapo">
        <img class="main-image" src="Images/volk.png" alt="Volk">
      </div>
      <img class="camera-icon" src="Images/camera_icon.png" alt="Camera">
      <div class="scanning-text">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É<br>–Ω–∞ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–∫—É–ª—å–ø—Ç—É—Ä</div>
    </div>
  </div>

  <!-- Access Popup -->
  <div class="access-popup">
    <img src="Images/access_popup.png" alt="Access Permission">
  </div>

  <!-- –æ–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–µ –±—É–¥—É—â–µ–µ ¬´–í–∞–∞–∞—É¬ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
    </div>
  </div>

  <!-- –∫–Ω–æ–ø–∫–∞ ¬´–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ¬ª -->
  <button id="photoBtn" disabled>üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>

  <!-- –ø–æ–ø-–∞–ø –ø—Ä–µ–≤—å—é -->
  <div id="previewOverlay" class="hidden">
    <div id="previewBox">
      <img id="previewImg" alt="preview">
      <div>
        <button id="downloadBtn">–°–∫–∞—á–∞—Ç—å</button>
        <button id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ø–æ–ø-–∞–ø –ø–æ—Å–ª–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
  <div id="afterOverlay" class="hidden">
    <div id="afterBox">
      <img id="afterImg" src="https://via.placeholder.com/400x300/007aff/ffffff?text=–°—É–ø–µ—Ä!" alt="–∑–∞—Å—Ç–∞–≤–∫–∞">
      <p> </p>
      <a href="https://souzmultpark.ru/" target="_blank">
        <button id="goParkBtn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ–∞–Ω—Å—ã</button>
      </a>
      <button id="laterBtn">–í –¥—Ä—É–≥–æ–π —Ä–∞–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!</button>
    </div>
  </div>

  <!-- AR-—Å—Ü–µ–Ω–∞ (–≤–∞—à–∞) -->
  <a-scene
  mindar-image="
    imageTargetSrc: sm_3x.mind;
    maxTrack: 3;
    uiLoading: #loading-overlay;
    uiScanning: #scanning-overlay;
    uiError: no;
    deviceConstraints: {
      video: {
        width:  { ideal: 1280 },
        height: { ideal: 720  },
        facingMode: 'environment'
      }
    }"
  color-space="sRGB"
  renderer="colorManagement: true, physicallyCorrectLights"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

    <!-- –ê—Å—Å–µ—Ç—ã -->
    <a-assets>
      <img id="card" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"/>
      <a-asset-item id="1" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
      <a-asset-item id="2" src="cube.glb"></a-asset-item>
      <img id="Oranges" src="Images/Oranges.png"/>
      <img id="Table" src="Images/Table.png"/>
      <img id="Lariska" src="Images/Lariska.png"/>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane material="shader:flat;" src="#Lariska" position="0.4 -0.5 0" height="1" width="1" rotation="0 0 0"></a-plane>
    </a-entity>

    <!-- –ß–µ–±—É—Ä–∞—à–∫–∞ -->
    <a-entity mindar-image-target="targetIndex: 1">
      <a-entity id="gif-element" geometry="primitive: plane; height:1; width:2"
                material="shader: gif; src: url(Video.gif)" position="0 2 0" visible="true"></a-entity>
      <a-plane material="shader:flat;" src="#Oranges" position="0 -0.25 0" height="1" width="1" rotation="0 0 0"></a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2">
      <a-plane material="shader:flat;" src="#Table" position="-0.3 -0.35 0" height="2" width="2" rotation="0 0 0"></a-plane>
    </a-entity>
  </a-scene>

  <!-- –ª–æ–≥–∏–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ -->
  <script src="capture.js"></script>
  
  <!-- –ê–Ω–∏–º–∞—Ü–∏—è access popup -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const accessPopup = document.querySelector('.access-popup');
      const loadingOverlay = document.querySelector('#loading-overlay');
      const scanningOverlay = document.querySelector('#scanning-overlay');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      setTimeout(() => {
        accessPopup.classList.add('show');
      }, 1000);
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è popup
      function hidePopup() {
        accessPopup.style.display = 'none';
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ popup
      function showPopup() {
        accessPopup.style.display = 'block';
      }
      
      // –°–∫—Ä—ã–≤–∞–µ–º popup –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —ç–∫—Ä–∞–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      const scanningObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (!scanningOverlay.classList.contains('hidden')) {
              hidePopup();
            }
          }
        });
      });
      
      // –°–∫—Ä—ã–≤–∞–µ–º popup –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —ç–∫—Ä–∞–Ω—É)
      const loadingObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (loadingOverlay.classList.contains('hidden')) {
              hidePopup();
            }
          }
        });
      });
      
      scanningObserver.observe(scanningOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      loadingObserver.observe(loadingOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // –ö–∞—Ä—É—Å–µ–ª—å –∫–∞—Ä—Ç–∏–Ω–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      let imageInterval = null;
      
      function startCarousel() {
        const images = document.querySelectorAll('.main-image');
        if (images.length === 0) return;
        
        let currentIndex = 0;
        
        function switchImage() {
          console.log('Switching image, current index:', currentIndex);
          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
          images[currentIndex].classList.remove('active');
          
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ
          currentIndex = (currentIndex + 1) % images.length;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ
          images[currentIndex].classList.add('active');
          console.log('New active image index:', currentIndex);
        }
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if (imageInterval) {
          clearInterval(imageInterval);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–º–µ–Ω—É –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        imageInterval = setInterval(switchImage, 3000);
        console.log('Carousel started');
      }
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å —Å—Ä–∞–∑—É
      setTimeout(startCarousel, 100);
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å –∫–æ–≥–¥–∞ —ç–∫—Ä–∞–Ω —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è
      const stopCarouselObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            if (scanningOverlay.classList.contains('hidden')) {
              if (imageInterval) {
                clearInterval(imageInterval);
                imageInterval = null;
                console.log('Carousel stopped');
              }
            } else {
              // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å –∫–æ–≥–¥–∞ —ç–∫—Ä–∞–Ω —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è
              setTimeout(startCarousel, 100);
            }
          }
        });
      });
      
      stopCarouselObserver.observe(scanningOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
    });
  </script>
</body>
</html>