<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Союзмультфильм AR - Фото с персонажами</title>

  <!-- CSS стили -->
  <link rel="stylesheet" href="css/spinner.css">
  <link rel="stylesheet" href="css/scanning.css">
  <link rel="stylesheet" href="css/capture.css">

  <!-- Таймер загрузки (должен быть загружен рано) -->
  <script src="js/loading-timeout.js"></script>
  
  <!-- Внешние библиотеки -->
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  
  <!-- Кастомные A-Frame компоненты -->
  <script src="js/aframe-spritesheet-animation.js"></script>
  <script src="js/ar-animations.js"></script>
</head>

<body>
  <!-- Экран сканирования маркеров -->
  <div id="scanning-overlay" class="hidden">
    <div class="scanning-container">
      <img class="stairs-image" src="images/stairs.png" alt="Лестница">
      <div class="image-carousel">
        <img class="main-image active" src="images/gena_cheba_shapo.png" alt="Гена Чебурашка Шапокляк">
        <img class="main-image" src="images/volk.png" alt="Волк">
      </div>
      <img class="camera-icon" src="images/camera_icon.png" alt="Иконка камеры">
      <div class="scanning-text">Наведите камеру<br>на скульптуру</div>
    </div>
  </div>

  <!-- Popup запроса доступа к камере -->
  <div class="access-popup">
    <img src="images/access_popup.png" alt="Запрос доступа к камере">
  </div>

  <!-- Экран загрузки -->
  <div id="loading-overlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">Загружаем ваше будущее «Вааау». Пожалуйста, подождите</div>
    </div>
  </div>

  <!-- Блок пульта с кнопкой съемки -->
  <div id="pultContainer">
    <img src="images/Pult.gif" alt="Пульт управления" id="pultImage">
    <button id="photoBtn" disabled></button>
  </div>

  <!-- Popup предварительного просмотра фото -->
  <div id="previewOverlay" class="hidden">
    <div id="previewBox">
      <button id="closeBtn" class="close-button">
        <img src="images/close_button.png" alt="Закрыть">
      </button>
      <div class="camera-illustration">
        <img src="images/camera_illustration.png" alt="Иллюстрация камеры">
      </div>
      <img id="previewImg" alt="Предварительный просмотр">
      <div class="save-text">Нажмите «Сохранить»<br>и подтвердите загрузку<br>вашей фотографии</div>
      <button id="downloadBtn" class="download-button">
        <img src="images/button_save.png" alt="Сохранить">
      </button>
    </div>
  </div>

  <!-- Popup после сохранения фото -->
  <div id="afterOverlay" class="hidden">
    <div id="afterBox">
      <button id="laterBtn" class="close-button">
        <img src="images/close_button.png" alt="Закрыть">
      </button>
      <div class="vr-illustration">
        <img src="images/vr_illustration.png" alt="VR иллюстрация">
      </div>
      <div class="park-photo-container">
        <img id="afterImg" src="images/park_photo_01.png" alt="Фото парка">
        <div class="to-park-overlay">
          <img src="images/to_park.png" alt="Перейти в парк">
        </div>
      </div>
      <div class="park-welcome-text">Мы ждем вас<br> в парке!</div>
      <div class="save-text">Ваше Фото сохранится <br>в папке «Загрузки»<br>(не в галерее)</div>
      <a href="https://souzmultpark.ru/" target="_blank">
        <button id="goParkBtn" class="download-button">
          <img src="images/buy_ticket.png" alt="Купить билет">
        </button>
      </a>
    </div>
  </div>

  <!-- AR сцена с 3D моделями -->
  <a-scene
    mindar-image="
      imageTargetSrc: sculptures.mind;
      maxTrack: 1;
      uiLoading: #loading-overlay;
      uiScanning: #scanning-overlay;
      uiError: no;
      missTolerance: 10;          
      filterMinCF: 0.0001;       
      filterBeta: 0.0001;         
      warmupTolerance: 20
      deviceConstraints: {
        video: {
          facingMode: 'environment'
        }
      }"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <!-- Загрузка 3D моделей и текстур -->
    <a-assets>
      <a-asset-item id="gena-cheba-shapo-model" src="models/gena-cheba-shapo-model-animated.glb"></a-asset-item>
      <a-asset-item id="volk-model" src="models/volk-model-animated.glb"></a-asset-item>
      <img id="sheet" src="images/sprite_sheet.jpg">
    </a-assets>

    <!-- Камера AR -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Маркер 1: Гена, Чебурашка, Шапокляк -->
    <a-entity mindar-image-target="targetIndex: 0" play-on-visible>
      <a-entity
        id="animated-model"
        gltf-model="#gena-cheba-shapo-model"
        position="0 0 0"
        scale="0.5 0.5 0.5">
      </a-entity>
      <a-plane
        id="gif-element"
        geometry="primitive: plane; height:0.35; width:0.51"
        material="shader: flat; src: #sheet; transparent: false;"
        spritesheet-animation="rows: 16; columns: 11; frameDuration: 0.1; loop: true;"
        position="-0.03 0.85 0.15"
        visible="true"
        scale="0 0 0">
      </a-plane>
    </a-entity>

    <!-- Маркер 2: Волк -->
    <a-entity mindar-image-target="targetIndex: 1" play-on-visible>
      <a-entity
        id="animated-model"
        gltf-model="#volk-model"
        position="0 0 0"
        scale="0.5 0.5 0.5">
      </a-entity>
      <a-plane
        id="gif-element"
        geometry="primitive: plane; height:0.35; width:0.51"
        material="shader: flat; src: #sheet; transparent: false;"
        spritesheet-animation="rows: 16; columns: 11; frameDuration: 0.1; loop: true;"
        position="-0.03 0.73 0.15"
        visible="true"
        scale="0 0 0">
      </a-plane>
    </a-entity>

  </a-scene>

  <!-- JavaScript модули -->
  <script src="js/capture.js"></script>
  <script src="js/ui-controls.js"></script>
  
</body>
</html>